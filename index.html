<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shanvi</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #0b141a; --sidebar: #111b21; --header: #202c33; 
            --user-msg: #005c4b; --bot-msg: #202c33; --text: #e9edef;
            --green: #00a884; --border: #333;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 300px; background: var(--sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; height: 100%; transition: 0.3s;
            position: absolute; z-index: 999;
        }
        @media (min-width: 769px) { .sidebar { position: relative; } }
        @media (max-width: 768px) { .sidebar { left: -100%; } .sidebar.active { left: 0; } }

        .sidebar-header { padding: 15px; background: var(--header); font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .new-chat-btn { margin: 10px; padding: 12px; background: var(--green); color: white; text-align: center; border-radius: 8px; cursor: pointer; }
        
        .nav-links { padding: 5px 10px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
        .nav-item { padding: 10px; cursor: pointer; color: #aaa; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.05); border-radius: 5px; }

        .chat-list { flex: 1; overflow-y: auto; padding: 0 10px; }
        .chat-item { 
            padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center; position: relative;
        }
        .chat-item:hover { background: rgba(255,255,255,0.05); }
        .chat-title { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        
        /* 3-Dot Menu in Sidebar */
        .chat-options { color: #aaa; padding: 5px; opacity: 0; transition: 0.2s; }
        .chat-item:hover .chat-options { opacity: 1; }
        .item-dropdown {
            position: absolute; right: 10px; top: 35px; background: #2a3942; 
            border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 1001; display: none; width: 120px;
        }
        .item-dropdown.show { display: block; }
        .drop-opt { padding: 10px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .drop-opt:hover { background: rgba(255,255,255,0.1); }
        .drop-opt.del { color: #ff6b6b; }

        /* --- MAIN CHAT --- */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; }
        .header { padding: 10px 15px; background: var(--header); display: flex; align-items: center; gap: 15px; height: 60px; }
        .menu-toggle { font-size: 20px; cursor: pointer; display: none; }
        @media (max-width: 768px) { .menu-toggle { display: block; } }

        #chat-box { flex: 1; overflow-y: auto; padding: 20px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: soft-light; background-color: var(--bg); }
        
        .msg { max-width: 80%; padding: 10px 15px; margin-bottom: 10px; border-radius: 10px; font-size: 15px; position: relative; word-wrap: break-word; }
        .user { align-self: flex-end; background: var(--user-msg); color: white; margin-left: auto; border-bottom-right-radius: 0; }
        .bot { align-self: flex-start; background: var(--bot-msg); color: white; border-bottom-left-radius: 0; }
        .time { font-size: 10px; text-align: right; opacity: 0.7; margin-top: 5px; }

        .input-area { padding: 10px; background: var(--header); display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px; border-radius: 20px; border: none; background: #2a3942; color: white; outline: none; }
        .btn { background: var(--green); color: white; border: none; padding: 12px 15px; border-radius: 50%; cursor: pointer; }

        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:900; display:none; }
        .overlay.active { display: block; }
    </style>
</head>
<body>

<div class="overlay" onclick="toggleSidebar()"></div>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span>Shanvi AI</span>
        <i class="fas fa-times" onclick="toggleSidebar()" style="cursor:pointer; display:none;" id="close-btn"></i>
    </div>
    
    <div class="new-chat-btn" onclick="startNewChat()">
        <i class="fas fa-plus"></i> New Chat
    </div>

    <div class="nav-links">
        <div class="nav-item" onclick="openModal('memory-modal')"><i class="fas fa-brain"></i> Memories</div>
        <div class="nav-item" onclick="openModal('diary-modal')"><i class="fas fa-book"></i> Diary</div>
    </div>

    <div class="chat-list" id="history-list">
        </div>
</div>

<div class="main">
    <div class="header">
        <i class="fas fa-bars menu-toggle" onclick="toggleSidebar()"></i>
        <div style="display:flex; align-items:center; gap:10px;">
            <div style="width:35px; height:35px; background:var(--green); border-radius:50%; display:flex; align-items:center; justify-content:center;">
                <i class="fas fa-heart" style="color:white;"></i>
            </div>
            <div>
                <div style="font-weight:bold;">Shanvi</div>
                <div style="font-size:11px; color:#aaa;">Online</div>
            </div>
        </div>
    </div>

    <div id="chat-box"></div>

    <div class="input-area">
        <i class="fas fa-paperclip" style="color:#aaa; font-size:20px; cursor:pointer;" onclick="document.getElementById('file').click()"></i>
        <input type="file" id="file" hidden onchange="alert('Image selected!')">
        <input type="text" id="msg-input" placeholder="Type a message...">
        <button class="btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<script>
    let currentSessionId = localStorage.getItem('shanvi_session_id') || null;

    // --- UI TOGGLES ---
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
        document.querySelector('.overlay').classList.toggle('active');
        const closeBtn = document.getElementById('close-btn');
        closeBtn.style.display = closeBtn.style.display === 'none' ? 'block' : 'none';
    }

    function openModal(id) {
        alert(id + " functionality files (modals) need to be in index.html to work. Link restored!");
        // Tumhare purane memory/diary modal code yahan hone chahiye
    }

    // --- CHAT LOGIC ---
    window.onload = function() {
        loadChatList();
        if(currentSessionId) loadChatHistory(currentSessionId);
    }

    async function loadChatList() {
        const res = await fetch('/get_chat_list');
        const data = await res.json();
        const list = document.getElementById('history-list');
        list.innerHTML = '';

        data.forEach(chat => {
            const div = document.createElement('div');
            div.className = 'chat-item';
            div.innerHTML = `
                <div class="chat-title" onclick="loadChatHistory('${chat.session_id}')">${chat.title}</div>
                <i class="fas fa-ellipsis-v chat-options" onclick="toggleItemMenu(event, '${chat.session_id}')"></i>
                
                <div class="item-dropdown" id="menu-${chat.session_id}">
                    <div class="drop-opt" onclick="renameChat('${chat.session_id}')"><i class="fas fa-pen"></i> Rename</div>
                    <div class="drop-opt del" onclick="deleteChat('${chat.session_id}')"><i class="fas fa-trash"></i> Delete</div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // Dropdown Toggle Logic
    let activeMenu = null;
    function toggleItemMenu(e, sid) {
        e.stopPropagation(); // Click item par na jaye
        const menu = document.getElementById(`menu-${sid}`);
        
        // Agar pehle se koi khula hai to band karo
        if(activeMenu && activeMenu !== menu) activeMenu.classList.remove('show');

        menu.classList.toggle('show');
        activeMenu = menu;
    }
    // Kahin aur click karne par menu band
    window.onclick = () => { if(activeMenu) { activeMenu.classList.remove('show'); activeMenu = null; } };

    async function loadChatHistory(sid) {
        currentSessionId = sid;
        localStorage.setItem('shanvi_session_id', sid);
        
        const res = await fetch(`/get_history?session_id=${sid}`);
        const msgs = await res.json();
        
        const box = document.getElementById('chat-box');
        box.innerHTML = ''; // Clear old
        msgs.forEach(m => appendMsg(m.content, m.role, m.time));
        
        // Mobile par sidebar band kar do selection ke baad
        if(window.innerWidth < 768) toggleSidebar();
    }

    function startNewChat() {
        currentSessionId = null;
        localStorage.removeItem('shanvi_session_id');
        document.getElementById('chat-box').innerHTML = '';
        if(window.innerWidth < 768) toggleSidebar();
    }

    async function sendMsg() {
        const input = document.getElementById('msg-input');
        const txt = input.value.trim();
        if(!txt) return;

        appendMsg(txt, 'user', 'Just now');
        input.value = '';

        const res = await fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message: txt, session_id: currentSessionId })
        });
        const data = await res.json();
        
        if(!currentSessionId) {
            currentSessionId = data.session_id; // Naya session save karo
            localStorage.setItem('shanvi_session_id', currentSessionId);
            loadChatList(); // List refresh karo taki naya chat dikhe
        }
        
        appendMsg(data.reply, 'model', data.time);
    }

    function appendMsg(text, role, time) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `msg ${role === 'user' ? 'user' : 'bot'}`;
        div.innerHTML = `${text.replace(/\n/g, '<br>')}<div class="time">${time}</div>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    // --- RENAME & DELETE ---
    async function renameChat(sid) {
        const newName = prompt("Enter new name:");
        if(newName) {
            await fetch('/rename_chat', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({session_id: sid, new_title: newName})
            });
            loadChatList();
        }
    }

    async function deleteChat(sid) {
        if(confirm("Delete this chat permanently?")) {
            await fetch('/delete_chat', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({session_id: sid})
            });
            if(currentSessionId === sid) startNewChat();
            loadChatList();
        }
    }
</script>
</body>
</html>
